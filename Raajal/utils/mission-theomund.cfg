disallow_recall=yes
next_scenario=null
victory_when_enemies_defeated=no
map_data="{@campaigns/Raajal/maps/King_Theomund.map}"
turns=24
{FULL_DAY}

[music]
	name=loyalists.ogg
[/music]

#The side you control
[side]
	side=1
	team_name=good
	controller=human
	no_leader=yes
[/side]

#The bad guys
[side]
  side=2
  team_name=bad
  controller=ai
  no_leader=yes
[/side]

#Idle good guys
[side]
  side=3
  team_name=good
  controller=null
  no_leader=yes
[/side]

#Idle bad guys
[side]
  side=4
  team_name=bad
  controller=null
  no_leader=yes
[/side]

#Orcs on your side
[side]
  side=5
  team_name=good
  controller=ai
  no_leader=yes
[/side]

#define THEOMUND_OBJECTIVE
	[if]
		[variable]
			name=theomund_objective_index
			equals=0
		[/variable]
		[then]
			[objectives]
				victory_string= _ "Objective: "
				[objective]
					condition=win
					description="Move Theomund to Barruk's castle"
				[/objective]
				[objective]
					condition=lose
					description="An orc patroller sees Theomund"
				[/objective]
			[/objectives] 
		[/then]
	[/if]

	[if]
		[variable]
			name=theomund_objective_index
			equals=1
		[/variable]
		[then]
			[objectives]
				victory_string= _ "Objective: "
				[objective]
					condition=win
					description="Move Theomund and the orcs across the river"
				[/objective]
				[objective]
					condition=lose
					description="You are spotted by one of Hector's men."
				[/objective]
			[/objectives] 
		[/then]
	[/if]

	[if]
		[variable]
			name=theomund_objective_index
			equals=2
		[/variable]
		[then]
			[objectives]
				note="Note: Units exit the mine after Gerald's men cross the river"
				victory_string= _ "Objective: "
				[objective]
					condition=win
					description="Attack Hector's castle"
				[/objective]
				[objective]
					condition=lose
					description="Death of Barruk"
				[/objective]
			[/objectives] 
		[/then]
	[/if]

	[if]
		[variable]
			name=theomund_objective_index
			equals=3
		[/variable]
		[then]
			[objectives]
				victory_string= _ "Objective: "
				[objective]
					condition=win
					description="Kill Gerald II"
				[/objective]
				[objective]
					condition=lose
					description="Death of Theomund"
				[/objective]
				[objective]
					condition=lose
					description="Death of Barruk"
				[/objective]
			[/objectives] 
		[/then]
	[/if]
#enddef

#define INIT_THEOMUND
	[event]
		name=prestart

		{VARIABLE theomund_objective_index 0}

		#Unstore Theomund and men east of the orc mountain
		{UNSTORE_AT theomund_store 1 23 10}
		{UNSTORE_AT horomir_store 3 22 10}
		{UNSTORE_AT theomund_men_store 3 (22-28) (11-13)}

		#Hector's men
		{UNIT_CREATE (Grand Marshal) Hector ( _ "Hector") 3 63 7 (canrecruit=yes)}
		{UNIT_CREATE (Grand Knight) Marcus ( _ "Marcus") 3 61 1 ()}

		#Gerald's men
		{UNIT_CREATE (Warrior King) (King Gerald II) ( _ "King Gerald II") 4 140 5 canrecruit=yes}
		{UNIT_CREATE Pikeman Jarrett ( _ "Jarrett") 4 133 5 (
			facing=sw
			ai_special=guardian)}
		{UNIT_CREATE Pikeman Julius ( _ "Julius") 4 133 9 (
			facing=sw
			ai_special=guardian)}

		#Orcs
		{UNIT_CREATE (Orcish Warlord) Barruk ( _ "Barruk") 3 5 2 (
			canrecruit=yes
			ai_special=guardian)}
		{UNIT_CREATE (Orcish Slurbow) Olag ( _ "Olag") 3 4 8 role=patrol}
		{UNIT_CREATE (Orcish Slurbow) Igok ( _ "Igok") 3 14 6 role=patrol}

		#Orc1 patrol
		{SET_PATROL 3 12 4 8 (3,4,4,5,6) (8-12,6-7,12,13,12)}
		{SET_PATROL 4 8 9 11 (3,4,5-6,7-8,9,10) (8-9,6-8,9,10,10-12,10-11)}
		{SET_PATROL 9 11 5 13 (3,4,5,5,6,6,7,7,8,9,10,11) (8,8,9,13,9,12,10,12,10-11,9-12,7-11,8)}
		{SET_PATROL 5 13 3 12 (3-4,5,6,7,8,9,10) (12,13,12,12,11,10-11,8-11)}

		#Orc2 patrol
		{SET_PATROL 14 9 10 7 (10,11,12,13,14,15,15) (7-8,8,8,9,2-11,6-7,10)}
		{SET_PATROL 10 7 10 4 (9,9,10,11,11-12,13-14,14,15) (5-6,10-12,4-11,4,8,9,8,10)}
		{SET_PATROL 10 4 11 3 (8,9,10,11,12,13) (6,5-6,4-11,3-5,5,5)}
		{SET_PATROL 11 3 14 3 (10,11,12,13) (4-5,3-5,2,3)}
		{SET_PATROL 14 3 14 6 (11,12,13,14,15,15,16) (3,2,3,2-11,2-3,7,2)}
		{SET_PATROL 14 6 14 9 (14,15,15,16,17) (2-11,2,6-7,7,8)}
		
		#Knight patrol
		{SET_PATROL 61 1 55 2 (50,51-53,54-55,56,57-59,60-62,63-64,65,66-77,78) (1,1-3,1-2,1,1-2,1,1-2,1-3,1-2,1)}
		{SET_PATROL 55 2 53 5 (49,50,50,51,51,52,53,54,55,56,57-59,60-63) (8,1,6-7,1-3,6-7,1-5,1-4,1-3,1-2,1,1-2,1)}
		{SET_PATROL 53 5 49 8 (49,50,51,51,52,52,53,54,54,54,55) (8-9,6-7,1-3,6-7,1-7,11-12,1-13,1-2,7,11-13,1)}
		{SET_PATROL 49 8 50 11 (48,49,50-51,52,53,54,54,55) (10,8-11,6-7,4-7,3-7,2-3,6,1-2)}
		{SET_PATROL 50 11 56 11 (44-45,46,47,48,49,50,51,52,53-54,55,56,57,58-60,61-62) (10,9-10,9-11,9-10,9-11,10-11,11-12,10-12,9-13,10-13,11-13,12-13,11-13,13)}
		{SET_PATROL 56 11 62 13 (45,46,47,48,49-50,51,52,53,54,55,56,57,58-60,61-62) (10,9-10,9-11,9-10,10-11,11-12,10-12,8-13,9-13,10-13,11-13,12-13,11-13,13)}
		{SET_PATROL 62 13 69 13 (46,47-48,49-50,51,52,53-54,55-56,57,58-60,61-63,64,65,66-67,68-71,72-75) (9,9-10,10-11,11-12,10-12,10-13,11-13,12-13,11-13,13,11-13,13,12-13,13,12-13)}
		{SET_PATROL 69 13 76 11 (54-63,64,65,66,67-69,70-71,72,73-75,76,77,78,79,80-81) (13,12-13,13,12-13,13,11-13,9-13,11-13,10-11,9-11,8-10,9,8)}
		{SET_PATROL 76 11 76 7 (66-69,70-71,72,73,74,74,75,75,76,77,78,79,80-81,82-83,84-85,86) (13,11-13,10-13,11-13,1-4,11-13,1-6,11-13,1-11,9-11,8-10,9,8,6-7,5-6,4)}
		{SET_PATROL 76 7 75 3 (71,72,72,72,73,73,73,74,75,76,77,77,78) (7,1,6,9,1-3,6-7,9,1-8,1-9,1-11,6,10-11,10)}
		{SET_PATROL 75 3 68 2 (61-62,63-72,73,73,74,75,76,77,77,77,78) (1,1-2,1-4,7,1-8,1-9,1-11,1-3,6,10-11,1)}
		{SET_PATROL 68 2 61 1 (60-62,63-64,65,66-77,78) (1,1-2,1-3,1-2,1)}

		#Hector patrol
		{SET_PATROL 63 7 63 7 (50-54,55,56,56,57,57,58,58,59,60,61,62,63,64,65,66,66,67,68,69-70) (6-7,7,6-7,12-13,5-7,12-13,3-7,11-13,4-13,4-11,5-11,4-10,5-11,3-13,1-10,1,4-9,5-9,6-7,7)}
	[/event]

	[event]
		name=start

		{UNIT_MSG (description=King Theomund) ( _ "Wait here while I speak with Barruk.")}
	[/event]

#enddef

[event] 
	name=prestart
	{PLACE_IMAGE "scenery/mine-abandoned.png" 102 10}
	{PLACE_IMAGE "scenery/mine-abandoned.png" 112 5}
[/event]

[event]
	name=start
	{THEOMUND_OBJECTIVE}
[/event]

#define END_THEOMUND
	{VARIABLE_OP next_pref format (Day$day_number)}
	{VARIABLE_OP next_level format ($next_pref|_Red_Sea)}

	[endlevel]
		result=continue
		next_scenario=$next_level
	[/endlevel]
#enddef

[event]
	name=time over
	{END_THEOMUND}
[/event]

[event]
	name=victory

	#Theomund or Barruk is dead: orcs will not help at the Red Sea
	[if]
		[not]
			[have_unit]
				description=Barruk
			[/have_unit]
		[/not]
		[or]
			#Theomund is not in the mine
			[variable]
				name=theomund_objective_index
				not_equals=2
			[/variable]
			#And Theomund is dead
			[not]
				[have_unit]
					description=King Theomund
				[/have_unit]
			[/not]
		[/or]
		[then]
			{VARIABLE theomund_failed yes}
			{THEOMUND_CLEAR_VARIABLES}
		[/then]
		[else]
			#Gerald II is dead: orcs will reach the Red Sea in 36 hours
			[if]
				[not]
					[have_unit]
						description=King Gerald II
					[/have_unit]
				[/not]
				[then]
					{VARIABLE orcs_arrive_hour $hour_number}
					{VARIABLE_OP orcs_arrive_hour add $turn_number}
					{VARIABLE_OP orcs_arrive_hour add 36}
					{STORE_UNITS theomund_orc_store (race=orc) no}
					{STORE_UNITS theomund_human_store (
						side=1
						race=human) no}
					{THEOMUND_CLEAR_VARIABLES}
				[/then]
				[else]
					#Otherwise, the mission will continue tomorrow
					{STORE_UNITS theomund_mission_store () no}
				[/else]
			[/if]
		[/else]
	[/if]
[/event]

[event]
	name=prestart

	{FOREACH theomund_mission_store i}
		[unstore_unit]
			variable=theomund_mission_store[$i]
		[/unstore_unit]
	{NEXT i}
[/event]

#define THEOMUND_CLEAR_VARIABLES
	{CLEAR_VARIABLE theomund_objective_index}
	{CLEAR_VARIABLE orc_gold}
	{CLEAR_VARIABLE gerald_gold}
	{CLEAR_VARIABLE turn_knight_reach_gerald}
	{CLEAR_VARIABLE turn_hadwin_exit_mine}
	{CLEAR_VARIABLE turn_knights_leave_castle}
	{CLEAR_VARIABLE turn_knights_attack}
#enddef



#define IF_ENEMY_SIGHTED X Y X_SIGHT Y_SIGHT
	[if]
		[have_unit]
			side=1
			[filter_location]
				x={X_SIGHT}
				y={Y_SIGHT}
			[/filter_location]
		[/have_unit]
		[then]

			{STORE_UNITS STORE (
				side=1
				[filter_location]
					x={X_SIGHT}
					y={Y_SIGHT}
				[/filter_location]) no}
			[if]
				[variable]
					name=STORE[0].x
					greater_than={X}
				[/variable]
				[then]
					{MODIFY_UNIT (
						x={X}
						y={Y}) facing se}
				[/then]
				[else]
					{MODIFY_UNIT (
						x={X}
						y={Y}) facing sw}
				[/else]
			[/if]
			{CLEAR_VARIABLE STORE}
#enddef

#define END_IF_ENEMY_SIGHTED
		[/then]
	[/if]
#enddef

#define SPAWN_UNITS_AT SIDE TYPE0 TYPE1 TYPE2 TYPE3 TYPE4 FILTER
	[store_locations]
		variable=locs
		{FILTER}
		[not]
			[filter]
			[/filter]
		[/not]
	[/store_locations]

	{VARIABLE type_0 ({TYPE0})} 
	{VARIABLE type_1 ({TYPE1})} 
	{VARIABLE type_2 ({TYPE2})} 
	{VARIABLE type_3 ({TYPE3})}
	{VARIABLE type_4 ({TYPE4})}

	#Create units
	{FOREACH locs i}
		{VARIABLE n $i}
		{VARIABLE_OP n modulo 5}
		{VARIABLE_OP type to_variable type_$n}
		{VARIABLE_OP x to_variable locs[$i].x}
		{VARIABLE_OP y to_variable locs[$i].y}
		{UNIT_NAMELESS $type ({SIDE}) $x $y}
	{NEXT i}
			
	{CLEAR_VARIABLE type_0}
	{CLEAR_VARIABLE type_1}
	{CLEAR_VARIABLE type_2}
	{CLEAR_VARIABLE type_3}
	{CLEAR_VARIABLE type_4}
	{CLEAR_VARIABLE type}
	{CLEAR_VARIABLE n}
	{CLEAR_VARIABLE locs}
#enddef

#define DO_PATROL FILTER WML_AFTER_SIGHTED
	[event]
		name=new turn
		first_time_only=no

		[if]
			[have_unit]
				{FILTER}
				side=3
				role=patrol
			[/have_unit]
			[then]

				#Check if a unit moved to within patroller's range of sight
				{STORE_UNITS store (
					side=3
					role=patrol
					{FILTER}) no}
				{FOREACH store i}
					{VARIABLE_OP x to_variable store[$i].x}
					{VARIABLE_OP y to_variable store[$i].y}
					{VARIABLE_OP x_sight to_variable (patrol_$x|_$y|.x_sight)}
					{VARIABLE_OP y_sight to_variable (patrol_$x|_$y|.y_sight)}
					{IF_ENEMY_SIGHTED $x $y $x_sight $y_sight}
						{UNIT_MSG (
							x=$x
							y=$y) ( _ "Enemy sighted!")}
						{WML_AFTER_SIGHTED}
						{MODIFY_UNIT (
							side=3
							role=patrol
							{FILTER}) role none}
						{VARIABLE i 100}
					{END_IF_ENEMY_SIGHTED}
				{NEXT i}
		
				#Check if an enemy is in sight after moving
				{STORE_UNITS store (
					side=3
					role=patrol
					{FILTER}) no}
				{FOREACH store i}
					{VARIABLE_OP x to_variable store[$i].x}
					{VARIABLE_OP y to_variable store[$i].y}
					{VARIABLE_OP x_sight to_variable (patrol_$x|_$y|.x_sight)}
					{VARIABLE_OP y_sight to_variable (patrol_$x|_$y|.y_sight)}
					{VARIABLE_OP x_next to_variable (patrol_$x|_$y|.x_next)}
					{VARIABLE_OP y_next to_variable (patrol_$x|_$y|.y_next)}
					#If patroller is not at it's final location
					[if]
						[not]
							[variable]
								name=x
								equals=$x_next
							[/variable]
							[variable]
								name=y
								equals=$y_next
							[/variable]
						[/not]
						[then]
							{VARIABLE_OP x_sight to_variable (patrol_$x_next|_$y_next|.x_sight)}
							{VARIABLE_OP y_sight to_variable (patrol_$x_next|_$y_next|.y_sight)}
							#Move patrol unit to next location
							{MOVE_UNIT (
								x=$x
								y=$y) $x_next $y_next}
							#Check for enemy
							{IF_ENEMY_SIGHTED $x_next $y_next $x_sight $y_sight}
								{UNIT_MSG (
									x=$x_next
									y=$y_next) ( _ "Enemy sighted!")}
								{WML_AFTER_SIGHTED}
								{VARIABLE i 100}
							{END_IF_ENEMY_SIGHTED}
						[/then]
					[/if]
				{NEXT i}
			[/then]
		[/if]
	[/event]
#enddef

#define SET_PATROL X Y X_NEXT Y_NEXT X_SIGHT Y_SIGHT
	{VARIABLE_OP var format patrol_{X}_{Y}.x_next}
	{VARIABLE $var ({X_NEXT})}
	{VARIABLE_OP var format patrol_{X}_{Y}.y_next}
	{VARIABLE $var ({Y_NEXT})}
	{VARIABLE_OP var format patrol_{X}_{Y}.x_sight}
	{VARIABLE $var ({X_SIGHT})}
	{VARIABLE_OP var format patrol_{X}_{Y}.y_sight}
	{VARIABLE $var ({Y_SIGHT})}
#enddef

#Failure if Theomund is spotted
{DO_PATROL race=orc (
	#Orc patrollers surround Theomund
	{STORE_UNITS theomund_store (description=King Theomund) no}
	{MOVE_UNIT (description=Olag) $theomund_store.x $theomund_store.y}
	{MOVE_UNIT (description=Igok) $theomund_store.x $theomund_store.y}
	{CLEAR_VARIABLE theomund_store}

	#Horomir hears the orc crossbows
	[scroll_to_unit]
		description=Horomir
	[/scroll_to_unit]
	[delay]
		time=500
	[/delay]
	[sound]
		name=crossbow.ogg
	[/sound]
	[sound]
		name=human-old-hit-1.ogg
	[/sound]
	[delay]
		time=500
	[/delay]
	[sound]
		name=crossbow.ogg
	[/sound]
	[sound]
		name=human-old-hit-2.ogg
	[/sound]
	[delay]
		time=500
	[/delay]
	[sound]
		name=crossbow.ogg
	[/sound]
	[sound]
		name=human-old-hit-3.ogg
	[/sound]

	{MODIFY_UNIT (description=Horomir) facing sw}
	{UNIT_MSG (description=Horomir) ( _ "Father!")}

	#Theomund is killed
	[redraw] [/redraw]
	[sound]
		name=crossbow.ogg
	[/sound]
	[sound]
		name=human-old-hit-4.ogg
	[/sound]
	[delay]
		time=500
	[/delay]
	[sound]
		name=crossbow.ogg
	[/sound]
	[kill]
		description=King Theomund
		animate=yes
	[/kill]

	{END_THEOMUND}
)}

#define SPAWN_GERALD_WAVE TYPE1 TYPE2 TYPE3 VAR_LOCS X_LIST Y_LIST
	[store_locations]
		variable={VAR_LOCS}
		x={X_LIST}
		y={Y_LIST}
	[/store_locations]

	[store_locations]
		variable=locs
		x={X_LIST}
		y={Y_LIST}
	[/store_locations]

	[unit]
		side=4
		type={TYPE1}
		x=$locs[0].x
		y=$locs[0].y
	[/unit]
	[unit]
		side=4
		type={TYPE2}
		x=$locs[1].x
		y=$locs[1].y
	[/unit]
	[unit]
		side=4
		type={TYPE2}
		x=$locs[2].x
		y=$locs[2].y
	[/unit]
	[unit]
		side=4
		type={TYPE3}
		x=$locs[3].x
		y=$locs[3].y
	[/unit]
	[unit]
		side=4
		type={TYPE3}
		x=$locs[4].x
		y=$locs[4].y
	[/unit]
	[unit]
		side=4
		type={TYPE3}
		x=$locs[5].x
		y=$locs[5].y
	[/unit]

	{CLEAR_VARIABLE locs}
#enddef

{DO_PATROL race=human (

	{MODIFY_UNIT (description=Hector) side 2}
	{MODIFY_UNIT (description=Marcus) side 2}

	[if]
		[have_unit]
			description=King Theomund
		[/have_unit]
		[then]
			{UNIT_MSG (
				side=1
				[not]
					description=King Theomund
				[/not]) ( _ "Retreat!")}
			[kill]
				description=King Theomund
			[/kill]
			{END_THEOMUND}
		[/then]
		[else]

			[sound]
				name=ambient/wardrums.ogg
			[/sound]

			[scroll_to_unit]
				description=King Gerald II
			[/scroll_to_unit]
		
			[delay]
				time=3000
			[/delay]

			{UNIT_MSG (description=King Gerald II) ( _ "Hector is in trouble!")}

			#Give Hector his men
			{SPAWN_UNITS_AT 2 (Swordsman) (Spearman) (Longbowman) (Sergeant) (Lieutenant) (
				x,y=61-65,6-9
				terrain=Ch
			)}

			#Spawn Gerald's army
			{SPAWN_GERALD_WAVE Cavalier Dragoon Cavalryman locs_wave1_north (134,135,136) (4,4-5,3-5)}
			{SPAWN_GERALD_WAVE (Grand Knight) Knight Horseman locs_wave1_south (134,135,136) (9,9-10,8-10)}
			{SPAWN_GERALD_WAVE General Lieutenant Sergeant locs_wave2_north (138-139) (4-6)}
			{SPAWN_GERALD_WAVE Halberdier Swordsman Spearman locs_wave2_south (138-139) (7-9)}
			{SPAWN_GERALD_WAVE (Master Bowman) Longbowman Javelineer locs_wave3_north (141-142) (4-6)}
			{SPAWN_GERALD_WAVE (Iron Mauler) (Shock Trooper) (Heavy Infantryman) locs_wave3_south (141-142) (7-9)}

			{MODIFY_UNIT (side=2) movement_costs.mountains 50}
			{MODIFY_UNIT (side=4) movement_costs.mountains 50}

			[redraw] [/redraw]
			[delay]
				time=2000
			[/delay]

			#First wave next turn
			{VARIABLE turn_wave1_depart $turn_number}
			{VARIABLE_OP turn_wave1_depart modulo 24}
			{VARIABLE_OP turn_wave1_depart add 1}
		[/else]
	[/if]
)}			

[event]
	name=moveto
	first_time_only=yes
	[filter]
		description=King Theomund
		x=1-8
		y=1-5
	[/filter]
	[if]
		[have_unit]
			side=3
			race=orc
		[/have_unit]
		[then]

			{UNIT_MSG (description=Barruk) ( _ "How did you get past my guards, filthy human?")}

			#If Meredith is at red sea by this time (doubtful), she'll tell Theomund what to say
			{VARIABLE theomund_speak_barruk_hour $hour_number}
			{VARIABLE_OP theomund_speak_barruk_hour add $turn_number}

			{UNIT_MSG (description=Julius) ( _ "Does anything strike you as odd about this whole situation?")}
			{UNIT_MSG (description=Jarrett) ( _ "What do you mean?")}
			{UNIT_MSG (description=Julius) ( _ "Why were the orcs so desperately trying to leave Wesnoth before we chased them into the mountains?")}
			{UNIT_MSG (description=Julius) ( _ "Why, instead of recuperating, do they persist in their futile attacks against us?")}
			{UNIT_MSG (description=Jarrett) ( _ "I don't know, but at this rate they'll all be dead within a fortnight.")}

			#Theomund moves closer to Hector's castle
			{STORE_UNITS theomund_store (description=King Theomund) yes}
			{VARIABLE theomund_store.facing sw}
			{VARIABLE theomund_store.x 44}
			{VARIABLE theomund_store.y 11}
			[unstore_unit]
				variable=theomund_store
				find_vacant=yes
			[/unstore_unit]

			#Give Theomund some orcs
			{NOTRAIT_UNIT 1 (Orcish Assassin) 44 13}
			{NOTRAIT_UNIT 1 (Orcish Assassin) 41 13}
			{NOTRAIT_UNIT 1 (Orcish Assassin) 42 13}
			{NOTRAIT_UNIT 1 (Orcish Assassin) 43 13}
			{NOTRAIT_UNIT 1 (Orcish Assassin) 42 12}
			{NOTRAIT_UNIT 1 (Orcish Slayer) 43 12}
			{NOTRAIT_UNIT 1 (Orcish Slayer) 44 12}

			#Horomir gets orcs
			[kill]
				side=3
				race=orc
			[/kill]
			{UNIT_CREATE (Orcish Warlord) Barruk ( _ "Barruk") 3 42 9 (canrecruit=yes)}
			{UNIT_CREATE (Orcish Slurbow) Olag ( _ "Olag") 3 42 8 ()}
			{UNIT_CREATE (Orcish Slurbow) Igok ( _ "Igok") 3 41 9 ()}

			#Give Horomir some more orcs
			{NOTRAIT_UNIT 3 (Orcish Archer) 40 7}
			{NOTRAIT_UNIT 3 (Orcish Archer) 41 7}
			{NOTRAIT_UNIT 3 (Orcish Archer) 39 7}
			{NOTRAIT_UNIT 3 (Orcish Grunt) 39 8}
			{NOTRAIT_UNIT 3 (Orcish Grunt) 40 8}
			{NOTRAIT_UNIT 3 (Orcish Grunt) 41 8}

			#Horomir is close to Hector's castle
			{STORE_UNITS store description=Horomir yes}
			{UNSTORE_AT store 3 38 8}

			#Store Horomir's human units
			{STORE_UNITS store (
				side=3
				[not]
					description=Horomir
				[/not]
				[not]
					race=orc
				[/not]
				x,y=1-45,1-13) yes}

			#Unstore Horomir's human units at empty locations near Hector's castle
			[store_locations]
				variable=locs
				x=27,28-29,30-31,32,33-34,35,36,36,37-41
				y=1-6,1-4,1-3,1-2,3,2-3,1-4,8,1-8
				[not]
					[filter]
					[/filter]
				[/not]
			[/store_locations]
	
			{VARIABLE j 0}
			{VARIABLE i $locs.length}
			[while]
				[variable]
					name=i
					greater_than=0
				[/variable]
				[variable]
					name=j
					less_than=$store.length
				[/variable]
				[do]	
					{VARIABLE_OP i add -1}
					{VARIABLE_OP store[$j].x to_variable locs[$i].x}
					{VARIABLE_OP store[$j].y to_variable locs[$i].y}
					[unstore_unit]
						variable=store[$j]
					[/unstore_unit]
					{VARIABLE_OP j add 1}
				[/do]
			[/while]
			{CLEAR_VARIABLE store}
			{CLEAR_VARIABLE locs}
			{CLEAR_VARIABLE i}
			{CLEAR_VARIABLE j}
			{UNSTORE_AT store 3 (35,36,38-41,39) (1-3,1-4,3-6,7)}

			{UNIT_MSG (description=King Theomund) ( _ "Horomir, after the orcs and I reach the other side of the river, you and Barruk will lead the attack on Hector's castle.")}

			#Marcus begins his patrol
			{MODIFY_UNIT (description=Marcus) role patrol}
			{MODIFY_UNIT (description=Hector) role patrol}

			#Next objective: get across the river
			{VARIABLE theomund_objective_index 1}
			{THEOMUND_OBJECTIVE}

			{MODIFY_UNIT (side=1) movement_costs.mountains 50}
		[/then]
	[/if]
[/event]

#Check if all of your units are across the river
[event]
	name=moveto
	first_time_only=no
	[filter]
		side=1
		x=88-100,89-100,90-100
		y=1-4,5-6,7-13
	[/filter]
	[if]
		[variable]
			name=theomund_objective_index
			equals=1
		[/variable]
		[not]
			[have_unit]
				side=1
				[filter_location]
					x=1-87,1-88,1-89
					y=1-4,5-6,7-13
				[/filter_location]
			[/have_unit]
		[/not]
		[then]
	
			#Store the units across the river
			{STORE_UNITS mine_store side=1 no}
		
			#Kill the unit standing on the entrance hex
			[kill]
				x,y=101,11
			[/kill]
			#Move and then kill the remaining units
			{STORE_UNITS store side=1 no}
			{FOREACH store i}
				{VARIABLE_OP x to_variable store[$i].x}
				{VARIABLE_OP y to_variable store[$i].y}
				{MOVE_UNIT (
					x=$x
					y=$y) 101 11}
				[kill]
					x,y=101,11
				[/kill]
			{NEXT i}
			{CLEAR_VARIABLE i}

			{UNIT_MSG (description=Barruk) ( _ "Move out!")}

			{MODIFY_UNIT (
				side=3
				x,y=1-42,1-13) side 1}

			{MODIFY_UNIT (side=1) movement_costs.mountains 50}

			#Next objective:Attack Hector's castle
			{VARIABLE theomund_objective_index 2}
			{THEOMUND_OBJECTIVE}

		[/then]
	[/if]
[/event]

#define TURN_AT_VAR TURN_VAR WML
	[event]
		name=new turn
		first_time_only=no
		[if]
			[variable]
				name={TURN_VAR}
				equals=$turn_number
			[/variable]
			[then]
				{WML}
				{VARIABLE ({TURN_VAR}) -1}
			[/then]
		[/if]
	[/event]
#enddef

{TURN_AT_VAR turn_wave1_depart (
	{VARIABLE turn_wave1_depart -1}

	{STORE_UNITS wave_north_store (
		x=134,135,136
		y=4,4-5,3-5) no}

	{STORE_UNITS wave_south_store (
		x=134,135,136
		y=9,9-10,8-10) no}

	#First wave departs
	{FOREACH wave_north_store i}
		{VARIABLE_OP x to_variable wave_north_store[$i].x}
		{VARIABLE_OP y to_variable wave_north_store[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) 130 1}
		[kill]
			x,y=130,1
		[/kill]

		{VARIABLE_OP x to_variable wave_south_store[$i].x}
		{VARIABLE_OP y to_variable wave_south_store[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) 130 13}
		[kill]
			x,y=130,13
		[/kill]
	{NEXT i}

	#Second wave moves forward
	{FOREACH locs_wave1_north i}
		{VARIABLE_OP x to_variable locs_wave2_north[$i].x}
		{VARIABLE_OP y to_variable locs_wave2_north[$i].y}
		{VARIABLE_OP x_to to_variable locs_wave1_north[$i].x}
		{VARIABLE_OP y_to to_variable locs_wave1_north[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) $x_to $y_to}

		{VARIABLE_OP x to_variable locs_wave2_south[$i].x}
		{VARIABLE_OP y to_variable locs_wave2_south[$i].y}
		{VARIABLE_OP x_to to_variable locs_wave1_south[$i].x}
		{VARIABLE_OP y_to to_variable locs_wave1_south[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) $x_to $y_to}
	{NEXT i}

	#Third wave moves forward
	{FOREACH locs_wave2_north i}
		{VARIABLE_OP x to_variable locs_wave3_north[$i].x}
		{VARIABLE_OP y to_variable locs_wave3_north[$i].y}
		{VARIABLE_OP x_to to_variable locs_wave2_north[$i].x}
		{VARIABLE_OP y_to to_variable locs_wave2_north[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) $x_to $y_to}

		{VARIABLE_OP x to_variable locs_wave3_south[$i].x}
		{VARIABLE_OP y to_variable locs_wave3_south[$i].y}
		{VARIABLE_OP x_to to_variable locs_wave2_south[$i].x}
		{VARIABLE_OP y_to to_variable locs_wave2_south[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) $x_to $y_to}
	{NEXT i}

	#First wave arrives next turn
	{VARIABLE turn_wave1_arrive $turn_number}
	{VARIABLE_OP turn_wave1_arrive modulo 24}
	{VARIABLE_OP turn_wave1_arrive add 1}
)}

{TURN_AT_VAR turn_wave1_arrive (
	{VARIABLE turn_wave1_arrive -1}

	{UNSTORE_AT wave_north_store 2 102 1}
	{UNSTORE_AT wave_south_store 2 96 13}

	#Second wave departs next turn
	{VARIABLE turn_wave2_depart $turn_number}
	{VARIABLE_OP turn_wave2_depart modulo 24}
	{VARIABLE_OP turn_wave2_depart add 1}
)}

{TURN_AT_VAR turn_wave2_depart (
	{VARIABLE turn_wave2_depart -1}

	{STORE_UNITS wave_north_store (
		x=134,135,136
		y=4,4-5,3-5) no}

	{STORE_UNITS wave_south_store (
		x=134,135,136
		y=9,9-10,8-10) no}

	#Second wave departs
	{FOREACH wave_north_store i}
		{VARIABLE_OP x to_variable wave_north_store[$i].x}
		{VARIABLE_OP y to_variable wave_north_store[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) 130 1}
		[kill]
			x,y=130,1
		[/kill]

		{VARIABLE_OP x to_variable wave_south_store[$i].x}
		{VARIABLE_OP y to_variable wave_south_store[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) 130 13}
		[kill]
			x,y=130,13
		[/kill]
	{NEXT i}

	#Third wave moves forward
	{FOREACH locs_wave1_north i}
		{VARIABLE_OP x to_variable locs_wave2_north[$i].x}
		{VARIABLE_OP y to_variable locs_wave2_north[$i].y}
		{VARIABLE_OP x_to to_variable locs_wave1_north[$i].x}
		{VARIABLE_OP y_to to_variable locs_wave1_north[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) $x_to $y_to}

		{VARIABLE_OP x to_variable locs_wave2_south[$i].x}
		{VARIABLE_OP y to_variable locs_wave2_south[$i].y}
		{VARIABLE_OP x_to to_variable locs_wave1_south[$i].x}
		{VARIABLE_OP y_to to_variable locs_wave1_south[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) $x_to $y_to}
	{NEXT i}

	#Second wave arrives next turn
	{VARIABLE turn_wave2_arrive $turn_number}
	{VARIABLE_OP turn_wave2_arrive modulo 24}
	{VARIABLE_OP turn_wave2_arrive add 1}
)}

{TURN_AT_VAR turn_wave2_arrive (
	{VARIABLE turn_wave2_arrive -1}

	{UNSTORE_AT wave_north_store 2 102 1}
	{UNSTORE_AT wave_south_store 2 96 13}

	#Second wave departs next turn
	{VARIABLE turn_wave3_depart $turn_number}
	{VARIABLE_OP turn_wave3_depart modulo 24}
	{VARIABLE_OP turn_wave3_depart add 1}
)}

{TURN_AT_VAR turn_wave3_depart (
	{VARIABLE turn_wave3_depart -1}

	{STORE_UNITS wave_north_store (
		x=134,135,136
		y=4,4-5,3-5) no}

	{STORE_UNITS wave_south_store (
		x=134,135,136
		y=9,9-10,8-10) no}

	#Second wave departs
	{FOREACH wave_north_store i}
		{VARIABLE_OP x to_variable wave_north_store[$i].x}
		{VARIABLE_OP y to_variable wave_north_store[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) 130 1}
		[kill]
			x,y=130,1
		[/kill]

		{VARIABLE_OP x to_variable wave_south_store[$i].x}
		{VARIABLE_OP y to_variable wave_south_store[$i].y}
		{MOVE_UNIT (
			x=$x
			y=$y) 130 13}
		[kill]
			x,y=130,13
		[/kill]
	{NEXT i}

	#Third wave arrives next turn
	{VARIABLE turn_wave3_arrive $turn_number}
	{VARIABLE_OP turn_wave3_arrive modulo 24}
	{VARIABLE_OP turn_wave3_arrive add 1}
)}

{TURN_AT_VAR turn_wave3_arrive (
	{VARIABLE turn_wave3_arrive -1}

	{UNSTORE_AT wave_north_store 2 102 1}
	{UNSTORE_AT wave_south_store 2 96 13}

	#Theomund exits the mine when Gerald's units cross the river
	{VARIABLE ready_exit_mine yes}

	#No more waves
	{CLEAR_VARIABLE turn_wave1_depart}
	{CLEAR_VARIABLE turn_wave2_depart}
	{CLEAR_VARIABLE turn_wave3_depart}
	{CLEAR_VARIABLE turn_wave1_arrive}
	{CLEAR_VARIABLE turn_wave2_arrive}
	{CLEAR_VARIABLE turn_wave3_arrive}
	{CLEAR_VARAIBLE wave_north_store}
	{CLEAR_VARAIBLE wave_south_store}
	{CLEAR_VARAIBLE locs_wave1_north}
	{CLEAR_VARAIBLE locs_wave2_north}
	{CLEAR_VARAIBLE locs_wave3_north}
	{CLEAR_VARAIBLE locs_wave1_south}
	{CLEAR_VARAIBLE locs_wave2_south}
	{CLEAR_VARAIBLE locs_wave3_south}
)}

#Theomund exits the mine when Gerald's units have crossed the river
[event]
	name=new turn
	first_time_only=no
	[if]
		[variable]
			name=ready_exit_mine
			equals=yes
		[/variable]
		[not]
			[have_unit]
				side=2
				x=88-105,89-105
				y=1-4,5-13
			[/have_unit]
		[/not]
		[then]
			{UNSTORE_AT mine_store 1 (112-115) (7-9)}
			{CLEAR_VARIABLE mine_store}

			{UNIT_MSG (description=King Gerald II) ( _ "Theomund!")}

			[sound]
				name=ambient/wardrums.ogg
			[/sound]

			[scroll_to_unit]
				description=Barruk
			[/scroll_to_unit]
		
			[delay]
				time=3000
			[/delay]

			{UNIT_MSG (side=2) ( _ "King Gerald is under attack!")}

			#Gerald's unmounted units will go back to the castle through the mine
			{VARIABLE out_of_mine yes}
			{MODIFY_UNIT_GOTO (
				side=2
				[wml_filter]
					[not]
						movement_type=mounted
					[/not]
				[/wml_filter]
				x,y=1-90,1-13) 101 11}

			#Gerald's units can move on mountains now
			#Note: this is a temporary fix until I set gotos around mountains
			{MODIFY_UNIT (
				side=2
				[wml_filter]
					[not]
						movement_type=mounted
					[/not]
				[/wml_filter]
			) movement_costs.mountains 4}

			#Gerald and the men at his castle can attack now
			{MODIFY_UNIT side=4 side 2}

			#Castle guards move to bridges
			{MOVE_UNIT (description=Jarrett) 133 4}
			{MOVE_UNIT (description=Julius) 133 10}

			{VARIABLE theomund_objective_index 3}
			{THEOMUND_OBJECTIVE}
		[/then]
	[/if]
[/event]

[event]
	name=moveto
	first_time_only=no
	[filter]
		x,y=101,11
	[/filter]
	[if]
		[variable]
			name=out_of_mine
			equals=yes
		[/variable]
		[then]
			{STORE_UNITS store (
				x=$x1
				y=$y1)  yes}
			[scroll_to]
				x,y=112,6
			[/scroll_to]
			[delay]
				time=1000
			[/delay]

			#If a unit is blocking the entrance, move it
			[if]
				[have_unit]
					x,y=112,6
				[/have_unit]
				[then]
					#Find an empty location
					[store_locations]
						variable=locs
						x=112,113,114-120,121-131
						y=7-10,7-10,5-10,1-13
						[not]
							[filter]
							[/filter]
						[/not]
					[/store_locations]
					[if]
						[variable]
							name=locs.length
							greater_than=0
						[/variable]
						[then]
							{MOVE_UNIT (x,y=112,6) $locs[0].x $locs[0].y}
						[/then]
						[else]
							#Thsi should only happen if you cheat
							{DEBUG_MSG ( _ "Error: could not move unit blocking the mine entrance")}
						[/else]
					[/if]
				[/then]
			[/if]
			{VARIABLE store.x 112}
			{VARIABLE store.y 6}
			[unstore_unit]
				variable=store
				find_vacant=no
			[/unstore_unit]
		[/then]
	[/if]
[/event]

#Death of Horomir
[event]
	name=die
	[filter]
		description=Horomir
	[/filter]
	{UNIT_MSG (description=Barruk) ( _ "Useless human!")}
[/event]

#Failure if Theomund is killed
[event]
	name=die
	[filter]
		description=King Theomund
	[/filter]
	{UNIT_MSG (description=King Theomund) ( _ "I have failed my family...")}
	{END_THEOMUND}
[/event]

#Failure if Barruk is killed
[event]
	name=die
	[filter]
		description=Barruk
	[/filter]
	[if]
		[have_unit]
			race=orc
			[not]
				description=Barruk
			[/not]
		[/have_unit]
		[then]
			{UNIT_MSG (
				race=orc
				[not]
					description=Barruk
				[/not]) ( _ "Our commander has been slain! Retreat!")}
		[/then]
		[else]
			{UNIT_MSG (
				x=$x2
				y=$y2) ( _ "I have slain the orc commander!")}
		[/else]
	[/if]
	{END_THEOMUND}
[/event]

#Victory when Gerald is killed
[event]
	name=die
	[filter]
		description=King Gerald II
	[/filter]
	{END_THEOMUND}
[/event]