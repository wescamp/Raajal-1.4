disallow_recall=yes
next_scenario=null
victory_when_enemies_defeated=no
map_data="{@campaigns/Raajal/maps/Red_Sea.map}"
{@campaigns/Raajal/utils/raajal-powers.cfg}
turns=24
{FULL_DAY}

[music]
	name=vengeful.ogg
[/music]

[side]
	side=1
	team_name=good
	controller=human
	no_leader=yes
	fog=yes
[/side]

[side]
	side=2
	team_name=ugly
	controller=ai
	no_leader=yes
	[ai]
		protect_leader=10.0
		protect_leader_radius=7
		caution=0.0
		aggression=1.0
		village_value=0
	[/ai]
[/side]

[side]
	side=3
	team_name=ugly
	controller=null
	no_leader=yes
[/side]

[side]
	side=4
	team_name=bad
	controller=ai
	no_leader=yes
[/side]

#define GIVE_POTION ID FILTER
	[object]
		id={ID}
		name= _ "Potion"
		image=items/potion-red.png
		silent=yes
		duration=forever
		description= _ "Splash the potion on a soul that knows you intimately."
		[filter]
			{FILTER}
		[/filter]
		[effect]
			apply_to=new_attack
			name=potion
			icon=items/potion-red.png
			type=arcane
			range=melee
			special=magical
			damage=1
			number=1
			[sound]
				time=-200
				sound=entangle.wav
			[/sound]
		[/effect]
	[/object]
#enddef

#define RED_SEA_SHARK X Y
	[unit]
		side=1
		type=Shark
		x={X}
		y={Y}
		[modifications]
			{TRAIT_LOYAL}
		[/modifications]
	[/unit]
#enddef

#define INIT_RED_SEA
	[event]
		name=prestart
		{VARIABLE witch_store.goto_x 0}
		{VARIABLE witch_store.goto_y 0}
		{UNSTORE_AT witch_store 1 19 38}
		{UNIT_CREATE (Sea Serpent Anna) Balthor ( _ "Balthor") 1 18 38 (canrecruit=1)}

		{GIVE_POTION potion1 type=Witch}

		{RED_SEA_SHARK 16 37}
		{RED_SEA_SHARK 17 37}
		{RED_SEA_SHARK 18 36}
		{RED_SEA_SHARK 19 36}
		{RED_SEA_SHARK 20 36}
		{RED_SEA_SHARK 21 37}
		{RED_SEA_SHARK 22 37}

		{UNIT_CREATE (Outlaw Alter) Zilead ( _ "Zilead") 3 4 3 ()}
		{UNIT_CREATE (Death Knight) Mordoc ( _ "Mordoc") 3 3 4 (ai_special=guardian)}
		{UNIT_CREATE (Death Knight) Gwurag ( _ "Gwurag") 3 5 5 (ai_special=guardian)}

		#Anna's family in in the NE castle
		{UNIT_CREATE (Lost Soul) Anna ( _ "Anna") 2 38 2 (
			ai_special=guardian
			variation=human-outlawqueen2)}
		{UNIT_CREATE (Lost Soul) Zeke ( _ "Zeke") 2 38 1 (
			ai_special=guardian
			variation=human-noblelord)}
		{UNIT_CREATE (Lost Soul) Bastian ( _ "Bastian") 2 39 2 (
			ai_special=guardian
			variation=human-kidblonde)}
		{UNIT_CREATE (Lost Soul) Irving ( _ "Irving") 2 39 3 (
			ai_special=guardian
			variation=human-kidbrunette)}
		{UNIT_CREATE (Lost Soul) Reuben ( _ "Reuben") 2 38 3 (
			ai_special=guardian
			variation=human-kidredhead)}

		#I forgot to re-store witch souls after Day1_Zilead (it's fixed now)
		[if]
			[variable]
				name=witch_soul_store.length
				greater_than=0
			[/variable]
			[then]
				{UNSTORE_AT witch_soul_store 2 (2,20,28,36) (15,2,4,10)}
			[/then]
			[else]
				{UNIT_CREATE (Lost Soul) Jezebel ( _ "Jezebel") 2 2 15 (variation=human-witch)}
				{UNIT_CREATE (Lost Soul) Amelia ( _ "Amelia") 2 20 2 (variation=human-witch)}
				{UNIT_CREATE (Lost Soul) Delora ( _ "Delora") 2 28 4 (variation=human-witch)}
				{UNIT_CREATE (Lost Soul) Mildred ( _ "Mildred") 2 36 10 (variation=human-witch)}
			[/else]
		[/if]

		#Store soul castle keeps (center hexes)
		[store_locations]
			variable=locs
			terrain=Y4
			[not]
				x,y=38,2 #Not family's castle
			[/not]
			[filter_adjacent_location]
				terrain=Y4
				count=6
			[/filter_adjacent_location]
		[/store_locations]	
		
		#Unstore souls at empty soul castle hexes
		{FOREACH soul_store i}
			{VARIABLE j $i}
			{VARIABLE_OP j modulo $locs.length}
			{VARIABLE_OP var format soul_store[$i].side}
			{VARIABLE $var 2}
			{VARIABLE_OP var format soul_store[$i].x}
			{VARIABLE_OP val to_variable locs[$j].x}
			{VARIABLE $var $val}
			{VARIABLE_OP var format soul_store[$i].y}
			{VARIABLE_OP val to_variable locs[$j].y}
			{VARIABLE $var $val}
			{VARIABLE_OP var format soul_store[$i].hitpoints}
			{VARIABLE_OP val to_variable soul_store[$i].max_hitpoints}
			{VARIABLE $var $val}
			[unstore_unit]
				variable=soul_store[$i]
				find_vacant=yes
			[/unstore_unit]
		{NEXT i}

		{CLEAR_VARIABLE soul_store}

		#Souls belong to Raajal
		{MODIFY_UNIT (type=Lost Soul) variables.owner Raajal}

		#Souls can't move through cave walls
		{MODIFY_UNIT (type=Lost Soul) movement_costs.cavewall 99}

		#Souls are guardians until killed for the first time
		{MODIFY_UNIT (type=Lost Soul) ai_special guardian}

		{CLEAR_VARIABLE locs}

		{FULL_HEAL (type=Lost Soul)}
	[/event]
#enddef

#define END_RED_SEA

	[if]
		[variable]
			name=raajal_dead
			equals=yes
		[/variable]
		[then]
			#If there is a human leader (note: there should be no non-human leaders)
			[if]
				[have_unit]
					side=1
					canrecruit=1
					[not]
						type=Witch
					[/not]
					[not]
						race=orc
					[/not]
				[/have_unit]
				[then]
					#All souls are good now
					{MODIFY_UNIT (
						side=2
						type=Lost Soul) side 1}
					[redraw]
						side=1
					[/redraw]

					[delay]
						time=1000
					[/delay]

					#Note: Balthor counts as a human
					{UNIT_MSG (
						side=1
						canrecruit=1
						[not]
							type=Witch
						[/not]
						[not]
							race=orc
						[/not]) ( _ "The nightmare is finally over.")}
				[/then]
			[/if]

			[endlevel]
				result=continue
			[/endlevel]

		[/then]
		[else]
			#Increment the day since this is the last mission of the day
			{VARIABLE_OP day_number add 1}

			#Defeat after 13 days
			[if]
				[variable]
					name=day_number
					equals=13
				[/variable]
				[then]
					[if]
						[have_unit]
							description=Raajal
						[/have_unit]
						[then]
							{UNIT_MSG (
								side=1
								canrecruit=1) ( _ "Raajal is unstoppable!")}
						[/then]
						[else]
							{UNIT_MSG (
								side=1
								canrecruit=1) ( _ "How are we to defeat Raajal if he does not show up?")}
						[/else]
					[/if]
					[endlevel]
						result=defeat
					[/endlevel]
				[/then]
			[/if]
		
			{VARIABLE_OP next_pref format (Day$day_number)}
			{VARIABLE_OP next_level format ($next_pref|_Randalf)}
		
			[if]
				#If Randalf finished his mission, go to Theomund's mission
				[variable]
					name=raajal_arrive_hour
					greater_than=0
				[/variable]
				[or]
					[variable]
						name=raajal_randalf_arrive_hour
						greater_than=0
					[/variable]
				[/or]
				[then]
					{VARIABLE_OP next_level format ($next_pref|_Theomund)}	
					[if]
						#If Theomund finished his mission, go to the next day of the Red Sea mission
						[variable]
							name=orcs_arrive_hour
							greater_than=0
						[/variable]
						[or]
							[variable]
								name=theomund_failed
								equals=yes
							[/variable]
						[/or]
						[then]
							{VARIABLE_OP next_level format ($next_pref|_Red_Sea)}
						[/then]
					[/if]
				[/then]
			[/if]
		
			{STORE_UNITS red_sea_store () no}
		[/else]
	[/if]

	[endlevel]
		result=continue
		next_scenario=$next_level
	[/endlevel]
#enddef

[event]
	name=prestart
	{MISSION_UNSTORE red_sea_store}
	{CLEAR_VARIABLE red_sea_store}

	#Raajal's castle is inaccessible until Theomund finished his mission
	{RAAJAL_BLOCK_CASTLE}

	#Block the witch cave if they didn't arrive yet
	[if]
		[variable]
			name=witches_arrive_hour
			greater_than=0
		[/variable]
		[variable]
			name=hour_number
			less_than=$witches_arrive_hour
		[/variable]
		[then]
			[terrain]
				x=4,5,6,7,8
				y=32,32,31,31,30
				terrain=Y3
			[/terrain]
		[/then]
	[/if]

	#Block Randalf's cave if he didn't arrive
	[if]
		[variable]
			name=raajal_randalf_arrive_hour
			greater_than=0
		[/variable]
		[variable]
			name=hour_number
			less_than=$raajal_randalf_arrive_hour
		[/variable]
		[then]
			[terrain]
				x=31,32,33
				y=35,34,34
				terrain=Y3
			[/terrain]
		[/then]
	[/if]

	#Block Raajal's cave if he hasn't arrived
	[if]
		[not]
			[have_unit]
				description=Raajal
			[/have_unit]
		[/not]
		[then]
			[terrain]
				x=10,11,12,13
				y=9,9,8,8
				terrain=Y3
			[/terrain]
		[/then]
		[else]
			#Show his boat
			{PLACE_IMAGE units/transport/boat.png 1 4}
		[/else]
	[/if]

	[objectives]
		summary="Steal souls from Raajal; attack his castle when ready"
		victory_string="End of day:"
		[objective]
			condition=win
			description="Death of Raajal"
		[/objective]
		[objective]
			condition=win
			description="Or, end of turns (you can continue next day)"
		[/objective]
		[objective]
			condition=lose
			description="Death of all leaders"
		[/objective]
		note="
How to steal a soul:
  1. Attack with potion (Raajal keeps his hp)
        (a) Witches can only steal witch souls
        (b) Humans can only steal human souls
  2. Attack with Randalf's soul (Raajal loses hp)"
	[/objectives]

	#If Ardella's daughter is a soul, make sure here name is Anna (not Balthor)
	[if]
		[have_unit]
			type=Lost Soul
			[wml_filter]
				variation=human-girl
			[/wml_filter]
			[not]
				description=Anna
			[/not]
		[/have_unit]
		[then]
			{MODIFY_UNIT (
				type=Lost Soul
				[wml_filter]
					variation=human-girl
				[/wml_filter])  user_description ( _ "Anna")}
			{MODIFY_UNIT (
				type=Lost Soul
				[wml_filter]
					variation=human-girl
				[/wml_filter])  description Anna)}
		[/then]
	[/if]

	#Clear common variables
	{CLEAR_VARIABLE store}
	{CLEAR_VARIABLE locs}
[/event]

[event]
	name=time over
	{END_RED_SEA}
[/event]

#define ACTIVATE_GUARDIANS FILTER

	#Store guardians matching the filter
	{STORE_UNITS AG_store (
		{FILTER}
		[wml_filter]
			[status]
				guardian=yes
			[/status]
		[/wml_filter]) no}

	#They are no longer guardians
	{FOREACH AG_store AG_i}
		{VARIABLE_OP var format AG_store[$AG_i].ai_special}
		{CLEAR_VARIABLE $var}
		{VARIABLE_OP var format AG_store[$AG_i].status.guardian}
		{VARIABLE $var no}
		[unstore_unit]
			variable=AG_store[$AG_i]
			find_vacant=no
		[/unstore_unit]
	{NEXT AG_i}

	{CLEAR_VARIABLE var}
	{CLEAR_VARIABLE AG_store}
	{CLEAR_VARIABLE AG_i}
#enddef

#define RAAJAL_BLOCK_CASTLE
	[if]
		#Raajal is at his castle
		[have_unit]
			description=Raajal
		[/have_unit]
		#Raajal has lost souls
		[have_unit]
			side=2
			type=Lost Soul
		[/have_unit]
		#Orcs are not on their way
		[not]
			[variable]
				name=orcs_arrive_hour
				greater_than=0
			[/variable]
		[/not]
		#Theomund wasn't killed in Wesnoth
		[variable]
			name=theomund_failed
			not_equals=yes
		[/variable]
		[then]
			[terrain]
				x,y=8,7
				terrain=Y3
			[/terrain]

			[event]
				name=moveto
				first_time_only=yes
				[filter]
					side=1
					x,y=9,8
				[/filter]
				[print]
					text=_ "Inaccessible until Theomund completes his mission"
					duration=200
					red,green,blue=255,255,255
				[/print]
			[/event]
		[/then]
	[/if]
#enddef

#define RAAJAL_START_ATTACK

	#Move Raajal to his keep
	[delay]
		time=1000
	[/delay]
	{MOVE_UNIT (description=Raajal) 4 2}
	[redraw] [/redraw]
	[delay]
		time=1000
	[/delay]
	
	#Create skeletons
	{NOTRAIT_UNIT 2 Draug 3 2}
	{NOTRAIT_UNIT 2 Revenant 4 1}
	{NOTRAIT_UNIT 2 Deathblade 5 2}
	{NOTRAIT_UNIT 2 Banebow 3 3}
	{NOTRAIT_UNIT 2 (Bone Shooter) 5 3}
	{NOTRAIT_UNIT 2 (Bone Shooter) 5 4}

	{UNIT_MSG (description=Raajal) ( _ "Find the witches! Find them and kill them!")}

	#Move them to the void terrain
	{MOVE_UNIT (x,y=5,4) 13 8}
	{MOVE_UNIT (x,y=5,3) 12 8}
	{MOVE_UNIT (x,y=5,2) 11 9}
	{MOVE_UNIT (x,y=3,3) 10 9}
	{MOVE_UNIT (x,y=3,2) 11 8}
	{MOVE_UNIT (x,y=4,1) 10 8}

	#Move Zilead's soul
	[if]
		[have_unit]
			description=Zilead
			type=Lost Soul
		[/have_unit]
		[then]
			{MOVE_UNIT description=Zilead 10 7}
		[/then]
	[/if]

	#Block his castle until Theomund finishes his mission
	{RAAJAL_BLOCK_CASTLE}

	[kill]
		type=Fog Clearer
	[/kill]

	{ACTIVATE_GUARDIANS (
		side=2
		type=Lost Soul
	)}
#enddef

[event]
	name=new turn
	first_time_only=no
	{VARIABLE_OP hour_number add 1}
	
	#Check if Raajal should arrive
	[if]
		[variable]
			name=hour_number
			equals=$raajal_arrive_hour
		[/variable]
		[then]
			#Unblock Raajal's cave
			[terrain]
				x=10,11,12,13
				y=9,9,8,8
				terrain=Y2
			[/terrain]

			#Clear Fog
			[unit]
				type=Fog Clearer
				x,y=4,4
				side=1
				moves=6
				ellipse="misc/blank-hex.png"
			[/unit]
			[redraw]
				side=1
			[/redraw]

			{MODIFY_UNIT side=3 side 2}

			{PLACE_IMAGE units/transport/boat.png 1 4}
			
			#I forgot to give Raajal the family's HP
			{VARIABLE_OP raajal_store.hitpoints add 78}
			{VARIABLE_OP raajal_store.max_hitpoints add 78}

			{UNSTORE_AT raajal_store 2 2 4}
			{UNSTORE_AT lich_store 2 (2,3) (5,6)}

			{MODIFY_UNIT (type=Ancient Lich) ai_special guardian}

			{FACE_EACH_OTHER (description=Raajal) (description=Mordoc)}

			{UNIT_MSG (description=Mordoc) ( _ "Welcome back, Master.")}
			{UNIT_MSG (description=Raajal) ( _ "Has the prisoner talked yet?")}
			{UNIT_MSG (description=Mordoc) ( _ "I am sorry, but he refuses to tell us anything. He says if he talks, his family will be killed.")}
			[redraw] [/redraw]
			[delay]
				time=1000
			[/delay]

			{MOVE_UNIT (description=Raajal) 5 4}
			{MODIFY_UNIT (description=Raajal) facing sw}

			[redraw] [/redraw]
			[delay]
				time=1000
			[/delay]
			{UNIT_MSG (description=Raajal) ( _ "Turn and face me!")}
			[redraw] [/redraw]
			[delay]
				time=1000
			[/delay]
			{MODIFY_UNIT (description=Zilead) type (Outlaw Alter SE)}
			[redraw] [/redraw]
			[delay]
				time=1000
			[/delay]
			{UNIT_MSG (description=Raajal) ( _ "Can they see me?")}
			{UNIT_MSG (description=Zilead) ( _ "Yes.")}
			{CONVERT_TO_SOUL (description=Raajal) (Undead General Power) 2 4 3 human-outlaw}
			{MODIFY_UNIT (description=Zilead) movement_costs.cavewall 99}
			{MODIFY_UNIT (description=Zilead) variables.owner Raajal}

			{PLACE_IMAGE items/alter-evil.png 4 3}
			[redraw] [/redraw]

			{RAAJAL_START_ATTACK}

		[/then]
	[/if]

	#Check if Raajal and Randalf should arrive
	[if]
		[variable]
			name=hour_number
			equals=$raajal_randalf_arrive_hour
		[/variable]
		[then]
			#Unblock Randalf and Raajal's caves
			[terrain]
				x=10,11,12,13
				y=9,9,8,8
				terrain=Y2
			[/terrain]
			[terrain]
				x=31,32,33
				y=35,34,34
				terrain=Y2
			[/terrain]

			{MODIFY_UNIT side=3 side 2}

			#Clear Fog
			[unit]
				type=Fog Clearer
				x,y=4,4
				side=1
				moves=6
				ellipse="misc/blank-hex.png"
			[/unit]
			[redraw]
				side=1
			[/redraw]

			{PLACE_IMAGE units/transport/boat.png 1 4}

			#I forgot to give Raajal the family's HP
			{VARIABLE_OP raajal_store.hitpoints add 78}
			{VARIABLE_OP raajal_store.max_hitpoints add 78}

			{UNSTORE_AT raajal_store 2 2 4}

			#Randalf has more hitpoints because of his souls
			{VARIABLE randalf_store.facing se}
			{VARIABLE randalf_store.hitpoints 110}
			{VARIABLE randalf_store.max_hitpoints 110}

			{UNSTORE_AT randalf_store 1 2 3}
			{UNSTORE_AT lich_store 2 (2,3) (5,6)}
			{MODIFY_UNIT (type=Ancient Lich) ai_special guardian}

			{UNIT_MSG (description=Randalf) ( _ "Zilead! What have you done to him?")}
			{UNIT_MSG (description=Raajal) ( _ "Is he still alive, Mordoc?")}
			{UNIT_MSG (description=Mordoc) ( _ "Just barely.")}
			{UNIT_MSG (description=Raajal) ( _ "Good. Take him and Randalf to the southeast cave.")}
			{UNIT_MSG (description=Mordoc) ( _ "Master?")}
			{UNIT_MSG (description=Raajal) ( _ "The witches are here. With Randalf's help we can finally destroy them all.")}

			#Mordoc, Randalf and Zilead head for the cave
			{STORE_UNITS randalf_store (description=Randalf) yes}
			{STORE_UNITS mordoc_store (description=Mordoc) yes}
			[kill]
				description=Zilead
			[/kill]
			[removeitem]
				x,y=1,4
			[/removeitem]

			#They will arrive in two turns
			{VARIABLE randalf_arrive_cave_hour $raajal_randalf_arrive_hour}
			{VARIABLE_OP randalf_arrive_cave_hour add 1}

			{RAAJAL_START_ATTACK}

		[/then]
	[/if]

	#Check if Randalf and Mordoc should arrive at the cave
	[if]
		[variable]
			name=hour_number
			equals=$randalf_arrive_cave_hour
		[/variable]
		[then]
			{PLACE_IMAGE units/transport/boat.png 40 40}
			{UNSTORE_AT randalf_store 1 37 38}
			{UNSTORE_AT mordoc_store 2 38 39}
			{UNIT_CREATE Outlaw Zilead ( _ "Zilead") 1 39 36 (hitpoints=1)}

			[redraw]
				side=1
			[/redraw]

			{UNIT_MSG (description=Mordoc) ( _ "If you betray Master, Randalf...")}
			
			{START_SOUL_POWER Randalf (Randalf Soul Power) 38 39}

			#Randalf's souls surround Mordoc
			{FOREACH randalf_kills_store i}
				{VARIABLE_OP type to_variable randalf_kills_store[$i].type}
				{VARIABLE_OP desc to_variable randalf_kills_store[$i].description}
				{VARIABLE_OP udesc to_variable randalf_kills_store[$i].user_description}
				[if]	
					[variable]
						name=type
						equals=Peasant
					[/variable]
					[then]
						{UNIT_CREATE (Lost Soul) ($desc) ($udesc) 1 38 39 (
							variation=human-peasant
							[variables]
								owner=Randalf
							[/variables]
						)}
					[/then]
					[else]
						{UNIT_CREATE (Lost Soul) ($desc) ($udesc) 1 38 39 (
							variation=human-woodsman
							[variables]
								owner=Randalf
							[/variables]
						)}
					[/else]
				[/if]
			{NEXT i}

			{CLEAR_VARIABLE randalf_kills_store}

			{MODIFY_UNIT (
				[wml_filter]
					variation=human-woodsman
				[/wml_filter]) movement_costs.cavewall 99}
			{MODIFY_UNIT (
				[wml_filter]
					variation=human-peasant
				[/wml_filter]) movement_costs.cavewall 99}

			{STOP_SOUL_POWER}
		
			{UNIT_MSG (description=Mordoc) ( _ "You scoundrel!")}
		[/then]
	[/if]

	#Check if witches should arrive
	[if]
		[variable]
			name=hour_number
			equals=$witches_arrive_hour
		[/variable]
		[then]
			#Unblock witch cave
			[terrain]
				x=4,5,6,7,8
				y=32,32,31,31,30
				terrain=Y2
			[/terrain]

			#Unstore Angalas survivors
			{UNSTORE_AT angalas_survivor_store 1 (8,9) (35-38,37)}
			{MODIFY_UNIT (
				x=8,9
				y=35-38,37) facing sw}
			#Let them move on castle terrain again
			{MODIFY_UNIT (
				x=8,9
				y=35-38,37) movement_costs.castle 1}

			{UNSTORE_AT angalas_witch_store 1 5 (35-39)}
			{MODIFY_UNIT (
				type=Witch
				x=5
				y=35-39) facing se}

			{MODIFY_UNIT_GOTO type=Witch 0 0}

			[redraw]
				side=1
			[/redraw]

			{UNIT_MSG (x,y=5,35) ( _ "Wait here. We will lure the souls towards you.")}
			{UNIT_MSG (x,y=5,36) ( _ "Remember, the potion will only work on souls that knew you intimately before their demise.")}

			{GIVE_POTION potion2 (x,y=5,35)}
			{GIVE_POTION potion3 (x,y=5,36)}
			{GIVE_POTION potion4 (x,y=5,37)}
			{GIVE_POTION potion5 (x,y=5,38)}
			{GIVE_POTION potion6 (x,y=5,39)}
			{GIVE_POTION potion7 (description=Ardella)}
			{GIVE_POTION potion8 (description=Leana)}
			{GIVE_POTION potion9 (description=Rogan)}
			{GIVE_POTION potion10 (description=Queen Edina)}
		[/then]
	[/if]

	#Check if Orcs and Theomund should arrive
	[if]
		[variable]
			name=hour_number
			equals=$orcs_arrive_hour
		[/variable]
		[then]
			{UNIT_CREATE (Pirate Galleon) (Theomund's Galleon) ( _ "Theomund's Galleon") 1 19 39 (canrecruit=1)}
			{UNIT_CREATE (Pirate Galleon) (Orc Galleon 1) ( _ "Barruk's Galleon") 1 18 39 ()}
			{UNIT_CREATE (Pirate Galleon) (Orc Galleon 2) ( _ "Orc Galleon") 1 16 40 ()}
			{UNIT_CREATE (Pirate Galleon) (Orc Galleon 3) ( _ "Orc Galleon") 1 17 40 ()}
			{UNIT_CREATE (Pirate Galleon) (Orc Galleon 4) ( _ "Orc Galleon") 1 20 39 ()}
			{UNIT_CREATE (Pirate Galleon) (Orc Galleon 5) ( _ "Orc Galleon") 1 21 40 ()}
			{UNIT_CREATE (Pirate Galleon) (Orc Galleon 6) ( _ "Orc Galleon") 1 22 40 ()}

			[redraw]
				side=1
			[/redraw]

			{UNIT_MSG (
				description=Orc Galleon 1
				caption=Barruk) ( _ "Death to Raajal!")}
		[/then]
	[/if]
[/event]

[event]
	name=die
	[filter]
		description=Theomund's Galleon
	[/filter]
	{UNSTORE_AT theomund_store 1 $x1 $y1}
	{UNSTORE_AT horomir_store 1 $x1 $y1}
	{FULL_HEAL (description=King Theomund)}
	{FULL_HEAL (description=Horomir)}
[/event]

[event]
	name=die
	[filter]
		description=Orc Galleon 1
	[/filter]
	{UNSTORE_AT theomund_orc_store 1 $x1 $y1}
	{FULL_HEAL race=orc}
	{MODIFY_UNIT (description=Barruk) canrecruit 0}
[/event]

[event]
	name=die
	[filter]
		description=Orc Galleon 2
	[/filter]
	{NOTRAIT_UNIT 1 (Orcish Crossbowman) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
[/event]

[event]
	name=die
	[filter]
		description=Orc Galleon 3
	[/filter]
	{NOTRAIT_UNIT 1 (Orcish Warrior) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Grunt) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Grunt) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Grunt) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Grunt) $x1 $y1}
[/event]

[event]
	name=die
	[filter]
		description=Orc Galleon 4
	[/filter]
	{NOTRAIT_UNIT 1 (Orcish Slurbow) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
[/event]

[event]
	name=die
	[filter]
		description=Orc Galleon 5
	[/filter]
	{NOTRAIT_UNIT 1 (Orcish Ruler) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Leader) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Leader) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Leader) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Grunt) $x1 $y1}
[/event]

[event]
	name=die
	[filter]
		description=Orc Galleon 6
	[/filter]
	{NOTRAIT_UNIT 1 (Orcish Leader) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Grunt) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Assassin) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Archer) $x1 $y1}
	{NOTRAIT_UNIT 1 (Orcish Grunt) $x1 $y1}
[/event]

#After first idle soul attacked, all idle souls will be controlled by AI
[event]
	name=attack
	first_time_only=yes
	[filter_second]
		side=3
	[/filter_second]
	
	{MODIFY_UNIT (
		side=3
		type=Lost Soul) side 2}
[/event]

#define START_SOUL_POWER DESC POWER_TYPE X Y
	[redraw] [/redraw]
	[scroll_to_unit]
		description={DESC}
	[/scroll_to_unit]
	[delay]
		time=500
	[/delay]
	[store_unit]
		variable=SOUL_POWER_STORE
		kill=no
		[filter]
			description={DESC}
		[/filter]
	[/store_unit]
	{MODIFY_UNIT (description={DESC}) type ({POWER_TYPE})}
	{FACE_X (description={DESC}) ({X})}

	[redraw] [/redraw]
	[delay]
		time=500
	[/delay]
	[scroll_to]
		x={X}
		y={Y}
	[/scroll_to]
	[delay]
		time=500
	[/delay]
#enddef

#define STOP_SOUL_POWER
	[if]
		[variable]
			name=SOUL_POWER_STORE.length
			greater_than=0
		[/variable]
		[not]
			[have_unit]
				type=$SOUL_POWER_STORE.type
				description=$SOUL_POWER_STORE.description
			[/have_unit]
		[/not]
		[then]
			[redraw] [/redraw]
#			[scroll_to_unit]
#				description=$SOUL_POWER_STORE.description
#			[/scroll_to_unit]
			[delay]
				time=1000
			[/delay]
			[unstore_unit]
				variable=SOUL_POWER_STORE
				find_vacant=no
			[/unstore_unit]
		[/then]
	[/if]
	{CLEAR_VARIABLE SOUL_POWER_STORE}
#enddef

#define UPDATE_MASTER_HP MASTER_HP_GAIN_DESC MASTER_HP_LOSE_DESC SOUL_HP

	{VARIABLE soul_hp ({SOUL_HP})}

	#Soul stealer gains hp
	[store_unit]
		variable=MASTER_STORE
		kill=no
		[filter]
			description={MASTER_HP_GAIN_DESC}
		[/filter]
	[/store_unit]
	{VARIABLE_OP MASTER_STORE.hitpoints add $soul_hp}
	{VARIABLE_OP MASTER_STORE.max_hitpoints add $soul_hp}
	[unstore_unit]
		variable=MASTER_STORE
		find_vacant=no
	[/unstore_unit]

	{FLOATING_TEXT (description={MASTER_HP_GAIN_DESC}) 255,0,0 $soul_hp}

	[if]
		[have_unit] #In case Randalf is the original soul owner and he is dead
			description={MASTER_HP_LOSE_DESC}
		[/have_unit]
		[then]
			[store_unit]
				variable=MASTER_STORE
				kill=no
				[filter]
					description={MASTER_HP_LOSE_DESC}
				[/filter]
			[/store_unit]
			{VARIABLE_OP soul_hp multiply -1}
			{VARIABLE_OP MASTER_STORE.hitpoints add $soul_hp}
			[if]
				[variable]
					name=MASTER_STORE.hitpoints
					less_than=1
				[/variable]
				[then]
					{VARIABLE MASTER_STORE.hitpoints 1}
				[/then]
			[/if]
			{VARIABLE_OP MASTER_STORE.max_hitpoints add $soul_hp}
			#Make sure max_hitpoints >= 40 (in case I forgot to give HP for all his souls)
			[if]
				[variable]
					name=MASTER_STORE.max_hitpoints
					less_than=40
				[/variable]
				[then]
					{VARIABLE MASTER_STORE.hitpoints 40}
				[/then]
			[/if]
			[unstore_unit]
				variable=MASTER_STORE
				find_vacant=no
			[/unstore_unit]
		[/then]
	[/if]
			
	{CLEAR_VARIABLE MASTER_STORE}
	{CLEAR_VARIABLE soul_hp}
#enddef

[event]
	name=die
	first_time_only=no
	[filter]
		type=Lost Soul
	[/filter]

	#For some unknown reason, "store" is cleared after macro START_SOUL_POWER
	#Temp. fix: the soul is created instead of unstored
	[store_unit]
		variable=store
		kill=no
		[filter]
			x=$x1
			y=$y1
		[/filter]
	[/store_unit]
	{VARIABLE s_type $store.type}
	{VARIABLE s_var $store.variation}
	{VARIABLE s_desc $store.description}
	{VARIABLE s_udesc $store.user_description}
	{VARIABLE s_maxhp $store.max_hitpoints}
	{VARIABLE s_side $store.side}
	{VARIABLE s_owner $store.variables.owner}
	{VARIABLE s_x $x1}
	{VARIABLE s_y $y1}

	#If Randalf or one of his souls killed it, it now belongs to him
	[if]
		[variable]
			name=s_owner
			equals=Raajal
		[/variable]
		[have_unit]
			x=$x2
			y=$y2
			[and]
				description=Randalf
				[or]
					type=Lost Soul
					[wml_filter]
						[variables]
							owner=Randalf
						[/variables]
					[/wml_filter]
				[/or]
			[/and]
		[/have_unit]
		[then]
			{UPDATE_MASTER_HP Randalf Raajal $s_maxhp}
			#Show Randalf's power
			{START_SOUL_POWER Randalf (Randalf Soul Power) $x1 $y1}
			{VARIABLE s_owner Randalf}
		[/then]
		[else]
			#If Raajal or one of his souls killed it, it now belongs to him
			[if]
				[variable]
					name=s_owner
					equals=Randalf
				[/variable]
				[have_unit]
					x=$x2
					y=$y2
					[and]
						description=Raajal
						[or]
							type=Lost Soul
							[wml_filter]
								[variables]
									owner=Raajal
								[/variables]
							[/wml_filter]
						[/or]
					[/and]
				[/have_unit]
				[then]
					{UPDATE_MASTER_HP Raajal Randalf $s_maxhp}

					{START_SOUL_POWER Raajal (Undead General Power) $x1 $y1}
					{VARIABLE s_owner Raajal}
				[/then]
			[/if]
		[/else]
	[/if]

	[if]
		[variable]
			name=s_owner
			equals=Raajal
		[/variable]
		[then]

			#Raajal's souls go back to one of his soul castles
			{VARIABLE s_side 2}
			#Find empty castle hexes
			[store_locations]
				variable=locs
				terrain=Y4
				[not]
					x=$x1
					y=$y1
					radius=2
				[/not]
				[not]
					[filter]
					[/filter]
				[/not]
				{CASTLE_FILTER}
			[/store_locations]
			[if]
				[variable]
					name=locs.length
					greater_than=0
				[/variable]
				[then]
					[if]
						[variable] 
							name=raajal_attacked
							equals=yes
						[/variable]
						[then]
							#If Raajal was attacked, soul goes to the left side
							{VARIABLE n 0}
						[/then]
						[else]
							#Otherwise, soul goes to right side
							{VARIABLE n $locs.length}
							{VARIABLE_OP n add -1}
						[/else]
					[/if]
					{VARIABLE_OP s_x to_variable locs[$n].x}
					{VARIABLE_OP s_y to_variable locs[$n].y}
					{CLEAR_VARIABLE n}
				[/then]
				[else]
					#All castle hexes are occupied (shouldn't happen)
					{VARIABLE s_x 20}
					{VARIABLE s_y 2}
				[/else]
			[/if]
		[/then]
		[else]
			#Randalf's souls go to the bottom of the map
			{VARIABLE s_side 1}
			{VARIABLE s_x 19}
			{VARIABLE s_y 39}
		[/else]
	[/if]

	{VARIABLE_OP movex format ($x1|,$s_x)}
	{VARIABLE_OP movey format ($y1|,$s_y)}
	[kill]
		x=$x1
		y=$y1
	[/kill]
	[move_unit_fake]
		type=Lost Soul
		x=$movex
		y=$movey
		side=$s_side
	[/move_unit_fake]

	{UNIT_CREATE ($s_type) ($s_desc) ($s_udesc) $s_side $s_x $s_y (
		variation=$s_var
		[variables]
			owner=$s_owner
		[/variables])}

	{MODIFY_UNIT (description=$s_desc) movement_costs.cavewall 99}
	{MODIFY_UNIT (description=$s_desc) attacks_left 0}
	{MODIFY_UNIT (description=$s_desc) moves 0}

	{STOP_SOUL_POWER}

	{CLEAR_VARIABLE locs}
	{CLEAR_VARIABLE store}
	{CLEAR_VARIABLE movex}
	{CLEAR_VARIABLE movey}
	{CLEAR_VARIABLE s_type}
	{CLEAR_VARIABLE s_var}
	{CLEAR_VARIABLE s_desc}
	{CLEAR_VARIABLE s_udesc}
	{CLEAR_VARIABLE s_maxhp}
	{CLEAR_VARIABLE s_side}
	{CLEAR_VARIABLE s_owner}
	{CLEAR_VARIABLE s_x}
	{CLEAR_VARIABLE s_y}

[/event]

#define FILTER_HERO
	side=1
	[and]
		race=human
		[or]
			type=Sea Serpent Anna
		[/or]
		[or]
			type=Gryphon Boy
		[/or]
	[/and]
#enddef

#define FIND_NEAREST_HERO X Y MAX_RADIUS NEAREST_X_VAR NEAREST_Y_VAR

	{VARIABLE ({NEAREST_X_VAR}) -1}
	{VARIABLE ({NEAREST_Y_VAR}) -1}

	#Find the unit nearest X,Y that matches the filter
	{VARIABLE RADIUS 1}
	[while]
		[variable]
			name=RADIUS
			less_than={MAX_RADIUS}
		[/variable]
		[not]
			[have_unit]
				{FILTER_HERO}
				[not]
					x={X}
					y={Y}
				[/not]
				[filter_location]
					x={X}
					y={Y}
					radius=$RADIUS
				[/filter_location]
			[/have_unit]
		[/not]
		[do]
			{VARIABLE_OP RADIUS add 1}
		[/do]
	[/while]

	#Store the nearest unit
	[store_unit]
		variable=NEAREST_STORE
		kill=no
		[filter]
			{FILTER_HERO}
			[not]
				x={X}
				y={Y}
			[/not]
			[filter_location]
				x={X}
				y={Y}
				radius=$RADIUS
			[/filter_location]
		[/filter]
	[/store_unit]

	#If a unit was found, store its x and y variables
	[if]
		[variable]
			name=NEAREST_STORE.length
			greater_than=0
		[/variable]
		[then]
			{VARIABLE ({NEAREST_X_VAR}) $NEAREST_STORE[0].x}
			{VARIABLE ({NEAREST_Y_VAR}) $NEAREST_STORE[0].y}
		[/then]
	[/if]

	{CLEAR_VARIABLE NEAREST_STORE}
	{CLEAR_VARIABLE RADIUS}
#enddef

#define DO_HERO_PRE_DEATH X Y DEFAULT_MSG FILTER_SPECIAL_UNIT SPECIAL_MSG
	[if]
		[not]
			[have_unit]
				x={X}
				y={Y}
			[/have_unit]
		[/not]
		[then]
			{FIND_NEAREST_HERO ({X}) ({Y}) 12 nearest_x nearest_y}
			[if]
				[variable]
					name=nearest_x
					greater_than=0
				[/variable]
				[then]
					[if]
						[have_unit]
							x=$nearest_x
							y=$nearest_y
							{FILTER_SPECIAL_UNIT}
						[/have_unit]
						[then]
							{UNIT_MSG (
								x=$nearest_x
								y=$nearest_y) ({SPECIAL_MSG})}
						[/then]
						[else]
							{UNIT_MSG (
								x=$nearest_x
								y=$nearest_y) ({DEFAULT_MSG})}
						[/else]
					[/if]
				[/then]
			[/if]
			{CLEAR_VARIABLE nearest_x}
			{CLEAR_VARIABLE nearest_y}
		[/then]
	[/if]
#enddef

#Note: replace with last breath event when it gets fixed
#define HERO_PRE_DEATH DESC DEFAULT_MSG FILTER_SPECIAL_UNIT SPECIAL_MSG
	[event]
		name=attack_end
		first_time_only=no
		[filter]
			description={DESC}
			[not]
				type=Lost Soul
			[/not]
		[/filter]
		{DO_HERO_PRE_DEATH $x1 $y1 ({DEFAULT_MSG}) ({FILTER_SPECIAL_UNIT}) ({SPECIAL_MSG})}
	[/event]
	[event]
		name=attack_end
		first_time_only=no
		[filter_second]
			description={DESC}
			[not]
				type=Lost Soul
			[/not]
		[/filter_second]
		{DO_HERO_PRE_DEATH $x2 $y2 ({DEFAULT_MSG}) ({FILTER_SPECIAL_UNIT}) ({SPECIAL_MSG})}
	[/event]
#enddef

{HERO_PRE_DEATH Ardella ( _ "Ardella!") (description=Zeke) ( _ "Momma!")}
{HERO_PRE_DEATH Zilead ( _ "Zilead!") (description=Zeke) ( _ "Papa!")}
{HERO_PRE_DEATH Zeke ( _ "Zeke!") (description=Ardella) ( _ "Zeke!")}
{HERO_PRE_DEATH Balthor ( _ "Anna!") (description=Ardella) ( _ "Anna!")}
{HERO_PRE_DEATH (Queen Edina) ( _ "Edina!") (
	description=Leana
	[or]
		description=Horomir
	[/or]) ( _ "Mother!")}
{HERO_PRE_DEATH (King Theomund) ( _ "Theomund!") (
	description=Leana
	[or]
		description=Horomir
	[/or]) ( _ "Father!")}
{HERO_PRE_DEATH Leana ( _ "Leana!") (description=Rogan) ( _ "Leana!")}
{HERO_PRE_DEATH Rogan ( _ "Rogan!") (description=Leana) ( _ "Rogan!")}
{HERO_PRE_DEATH Horomir ( _ "Rogan!") (description=Leana) ( _ "Horomir!")}

#define RAAJAL_DEAD_TO_SOUL TYPE  SOUL_VARIATION
	[event]
		name=die
		first_time_only=no
		[filter]
			type={TYPE}
			[and]
				side=1
				[or]
					side=4
				[/or]
			[/and]
		[/filter]
		[filter_second]
			description=Raajal
			[or]
				type=Lost Soul
#				[and]
#					side=2
#					[or]
#						side=3
#					[/or]
#				[/and]
			[/or]
		[/filter_second]

		[if]
			[have_unit]
				description=Raajal
			[/have_unit]
			[then]
				{CONVERT_TO_SOUL (description=Raajal) (Undead General Power) 2 $x1 $y1 ({SOUL_VARIATION})}
				{MODIFY_UNIT (
					x=$x1
					y=$y1) movement_costs.cavewall 99}
				{MODIFY_UNIT (
					x=$x1
					y=$y1) variables.owner Raajal}

				#Balthor gets renamed to Anna
				[if]
					[have_unit]
						x=$x1
						y=$y1
						[wml_filter]
							variation=human-girl
						[/wml_filter]
					[/have_unit]
					[then]
						{MODIFY_UNIT (
							x=$x1
							y=$y1) user_description ( _ "Anna")}
						{MODIFY_UNIT (
							x=$x1
							y=$y1) description Anna}
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

{RAAJAL_DEAD_TO_SOUL Witch human-witch}
{RAAJAL_DEAD_TO_SOUL (Warrior King) human-king}
{RAAJAL_DEAD_TO_SOUL (Dark Queen) human-queen}
{RAAJAL_DEAD_TO_SOUL (Battle Princess) human-princess}
{RAAJAL_DEAD_TO_SOUL (Royal Guard Hero) human-royalguardhero}
{RAAJAL_DEAD_TO_SOUL (Grand Marshal) human-marshal}
{RAAJAL_DEAD_TO_SOUL (Gryphon Boy) human-boy}
{RAAJAL_DEAD_TO_SOUL (Sea Serpent Anna) human-girl}
{RAAJAL_DEAD_TO_SOUL (Outlaw) human-outlaw}
{RAAJAL_DEAD_TO_SOUL (Fugitive) human-fugitive}
{RAAJAL_DEAD_TO_SOUL (Outlaw Queen) human-outlaw-queen}

[event]
	name=attack_end
	first_time_only=no
	[special_filter]
		weapon=potion
	[/special_filter]
	[filter]
		type=Witch
	[/filter]
	[filter_second]
		type=Lost Soul
		[wml_filter]
			variation=human-witch
		[/wml_filter]
	[/filter_second]
	
	{STORE_UNIT_VAR (
		x=$x1
		y=$y1) side side}
	{MODIFY_UNIT (
		x=$x2
		y=$y2) side $side}
		
	{CLEAR_VARIABLE side}
[/event]

#define HUMAN_FREE_SOUL VARIATION
	[event]
		name=attack_end
		first_time_only=no
		[special_filter]
			weapon=potion
		[/special_filter]
		[filter]
			[not]
				type=Witch
			[/not]
		[/filter]
		[filter_second]
			type=Lost Soul
			[wml_filter]
				variation={VARIATION}
			[/wml_filter]
		[/filter_second]
		
		{STORE_UNIT_VAR (
			x=$x1
			y=$y1) side side}
		{MODIFY_UNIT (
			x=$x2
			y=$y2) side $side}
			
		#If human was killed, give it 1 hp
#		[if]
#			[not]
#				[have_unit]
#					x=$x1
#					y=$y1
#				[/have_unit]
#			[/not]
#			[then]
#				{MODIFY_UNIT (
#					x=$x1
#					y=$y1) hitpoints 1}
#			[/then]
#		[/if]

		{CLEAR_VARIABLE side}
	[/event]
#enddef

{HUMAN_FREE_SOUL human-king}
{HUMAN_FREE_SOUL human-queen}
{HUMAN_FREE_SOUL human-princess}
{HUMAN_FREE_SOUL human-royalguardhero}
{HUMAN_FREE_SOUL human-marshal}
{HUMAN_FREE_SOUL human-boy}
{HUMAN_FREE_SOUL human-girl}
{HUMAN_FREE_SOUL human-outlaw}
{HUMAN_FREE_SOUL human-fugitive}
{HUMAN_FREE_SOUL human-outlaw-queen}
{HUMAN_FREE_SOUL human-noblelord}
{HUMAN_FREE_SOUL human-outlawqueen2}
{HUMAN_FREE_SOUL human-kidblonde}
{HUMAN_FREE_SOUL human-kidbrunette}
{HUMAN_FREE_SOUL human-kidredhead}
{HUMAN_FREE_SOUL human-royalguard}
{HUMAN_FREE_SOUL human-masterbowman}
{HUMAN_FREE_SOUL human-swordsman}
{HUMAN_FREE_SOUL human-grand-knight}

#Raajal gets Randalf's souls when he dies
[event]
	name=die
	[filter]
		description=Randalf
	[/filter]
	{STORE_UNITS store (
		type=Lost Soul
		[wml_filter]
			[variables]
				owner=Randalf
			[/variables]
		[/wml_filter]) no}
	[if]
		[variable]
			name=store.length
			greater_than=0
		[/variable]
		[then]

			{VARIABLE hp_gain 0}
			{FOREACH store i}
				{VARIABLE_OP hp to_variable store[$i].max_hitpoints}
				{VARIABLE_OP hp_gain add $hp}
				{VARIABLE store[$i].variables.owner Raajal}
				{VARIABLE store[$i].side 2}
				[unstore_unit]
					variable=store[$i]
					find_vacant=no
				[/unstore_unit]
			{NEXT i}

			#Raajal gets the hitpoints of Randalf's souls
			{UPDATE_MASTER_HP Raajal Randalf $hp_gain}

			#Show Raajal's power (he looks se)
			{START_SOUL_POWER Raajal (Undead General Power) $x1 $y1}

			#Stop Raajal's power
			{STOP_SOUL_POWER}
		[/then]
	[/if]
	{CLEAR_VARIABLE store}
[/event]

[event]
	name=die
	[filter]
		description=Raajal
	[/filter]
	{VARIABLE raajal_dead yes}
	{END_RED_SEA}
[/event]

[event]
	name=attack_end
	first_time_only=yes
	[filter_second]
		description=Raajal
	[/filter_second]
	{VARIABLE raajal_attacked yes}
[/event]
		
#After a guardian moves, it stops being a guardian
[event]
	name=moveto
	first_time_only=no
	[filter]
		side=2
		[wml_filter]
			[status]
				guardian=yes
			[/status]
		[/wml_filter]
	[/filter]
	{ACTIVATE_GUARDIANS (
		x=$x1
		y=$y1
	)}
[/event]

#Before version 0.9.7, Angalas survivors couldn't move on castle terrain
#This event is for people who made it to day 4 before day 3 was fixed
[event]
	name=prestart
	{MODIFY_UNIT (
		side=1
		[wml_filter]
			[movement_costs]
				castle=50
			[/movement_costs]
		[/wml_filter]) movement_costs.castle 1}
[/event]